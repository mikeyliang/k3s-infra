apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: seafile-data
  namespace: app-internal
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn
  resources:
    requests:
      storage: 100Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: seafile
  namespace: app-internal
spec:
  replicas: 1
  selector:
    matchLabels:
      app: seafile
  template:
    metadata:
      labels:
        app: seafile
    spec:
      containers:
        - name: seafile
          image: seafileltd/seafile-mc:11.0-latest
          env:
            - name: DB_HOST
              value: "mariadb-galera-primary.database.svc.cluster.local"
            - name: DB_ROOT_PASSWD
              valueFrom:
                secretKeyRef:
                  name: mariadb-root
                  key: password
            - name: TIME_ZONE
              value: "America/New_York"
            - name: SEAFILE_ADMIN_EMAIL
              value: "liangmichael27822@gmail.com"
            - name: SEAFILE_ADMIN_PASSWORD
              value: "Nshd20020811!"
            - name: SEAFILE_SERVER_LETSENCRYPT
              value: "false"
            - name: SEAFILE_SERVER_HOSTNAME
              value: "files.mikey-liang.com"
            - name: SEAFILE_SERVER_PROTOCOL
              value: "https"
          ports:
            - containerPort: 80
              name: http
          volumeMounts:
            - name: seafile-data
              mountPath: /shared
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 4Gi
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/bash
                  - -c
                  - |
                    # Wait for Seafile to create config files
                    for i in {1..60}; do
                      if [ -f /shared/seafile/conf/seahub_settings.py ]; then
                        # Check if CSRF setting already exists
                        if ! grep -q "CSRF_TRUSTED_ORIGINS" /shared/seafile/conf/seahub_settings.py; then
                          echo "" >> /shared/seafile/conf/seahub_settings.py
                          echo "# Auto-added HTTPS configuration" >> /shared/seafile/conf/seahub_settings.py
                          echo "CSRF_TRUSTED_ORIGINS = ['https://files.mikey-liang.com']" >> /shared/seafile/conf/seahub_settings.py
                          echo "FILE_SERVER_ROOT = 'https://files.mikey-liang.com/seafhttp'" >> /shared/seafile/conf/seahub_settings.py
                          echo "ALLOWED_HOSTS = ['*']" >> /shared/seafile/conf/seahub_settings.py
                          echo "SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')" >> /shared/seafile/conf/seahub_settings.py
                        fi
                        # Fix SERVICE_URL in ccnet.conf
                        if [ -f /shared/seafile/conf/ccnet.conf ]; then
                          sed -i 's|SERVICE_URL = .*|SERVICE_URL = https://files.mikey-liang.com|' /shared/seafile/conf/ccnet.conf
                        fi
                        break
                      fi
                      sleep 2
                    done
      volumes:
        - name: seafile-data
          persistentVolumeClaim:
            claimName: seafile-data
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: seafile
  namespace: app-internal
spec:
  selector:
    app: seafile
  type: ClusterIP
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
      name: http
