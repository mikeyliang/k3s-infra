# chart: bitnami/redis
# install: helm install redis bitnami/redis -n database -f values.yaml
# upgrade: helm upgrade redis bitnami/redis -n database -f values.yaml

# architecture: replication with sentinel for high availability
architecture: replication

# image - pinned versions for production
image:
  registry: docker.io
  repository: bitnami/redis
  tag: latest

# authentication
auth:
  enabled: true
  existingSecret: "redis-password"
  existingSecretPasswordKey: "password"
  sentinel: true

# master configuration
master:
  # resource limits
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

  # persistence with longhorn
  persistence:
    enabled: true
    storageClass: "longhorn"
    size: 8Gi
    accessModes:
      - ReadWriteOnce

  # redis configuration
  configuration: |-
    maxmemory 768mb
    maxmemory-policy allkeys-lru
    save 900 1
    save 300 10
    save 60 10000

  # service configuration
  service:
    type: LoadBalancer
    loadBalancerIP: 10.3.0.55
    annotations:
      metallb.universe.tf/address-pool: app-database

# replica configuration
replica:
  # number of replica nodes
  replicaCount: 2

  # resource limits
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

  # persistence with longhorn
  persistence:
    enabled: true
    storageClass: "longhorn"
    size: 8Gi
    accessModes:
      - ReadWriteOnce

  # service configuration
  service:
    type: ClusterIP

# sentinel configuration for automatic failover
sentinel:
  enabled: true

  # number of sentinel nodes (should be odd number, min 3 for quorum)
  quorum: 2

  auth:
    enabled: true
    existingSecret: "redis-password"
    existingSecretPasswordKey: "password"

  # resource limits
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "100m"

  image:
    registry: docker.io
    repository: bitnami/redis-sentinel
    tag: latest

  # persistence for sentinel
  persistence:
    enabled: false

# metrics - optional for monitoring
metrics:
  enabled: false
  serviceMonitor:
    enabled: false
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "200m"

# security context
securityContext:
  enabled: true
  fsGroup: 1001
  runAsUser: 1001

containerSecurityContext:
  enabled: true
  runAsUser: 1001
  runAsNonRoot: true
  allowPrivilegeEscalation: false

# volume permissions - disabled to avoid init container issues
volumePermissions:
  enabled: false

# sysctl - disabled
sysctl:
  enabled: false

# tls - optional
tls:
  enabled: false

# common labels
commonLabels:
  app.kubernetes.io/component: redis
  app.kubernetes.io/part-of: infrastructure
